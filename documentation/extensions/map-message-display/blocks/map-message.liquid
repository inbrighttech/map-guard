{% comment %}
  MAP Guard - Minimum Advertised Pricing Display Block
  Shows custom message when MAP pricing is enabled for a variant
{% endcomment %}

{% liquid
  assign current_variant = product.selected_or_first_available_variant
  
  # Get metafield values
  assign map_enabled_raw = current_variant.metafields.mapguard.enabled.value
  assign final_price = current_variant.metafields.mapguard.final_price.value
  assign display_message_raw = current_variant.metafields.mapguard.display.value
  assign custom_message_raw = current_variant.metafields.mapguard.custom_message.value
  
  # Convert map_enabled to proper boolean
  assign map_enabled = false
  if map_enabled_raw == true or map_enabled_raw == "true" or map_enabled_raw == 1
    assign map_enabled = true
  endif
  
  # Convert display_message flag to proper boolean
  assign show_message = true
  if display_message_raw == false or display_message_raw == "false" or display_message_raw == 0
    assign show_message = false
  endif
  
  # Clean custom message - avoid boolean strings
  assign custom_message = ""
  if custom_message_raw != blank and custom_message_raw != "" and custom_message_raw != "true" and custom_message_raw != "false" and custom_message_raw != true and custom_message_raw != false
    assign custom_message = custom_message_raw
  endif
  
  # Set the display message with clear priority
  assign display_message = "Add to cart for lower price"
  if block.settings.default_message != blank and block.settings.default_message != ""
    assign display_message = block.settings.default_message
  endif
  if custom_message != ""
    assign display_message = custom_message
  endif
%}

{% if map_enabled == true and show_message == true and current_variant.price > final_price %}
  <div class="map-guard-message" {{ block.shopify_attributes }}>
    {% if block.settings.icon_type != 'none' %}
      <span class="map-guard-icon">
        {% case block.settings.icon_type %}
          {% when 'info' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
          {% when 'warning' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
          {% when 'lock' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <circle cx="12" cy="16" r="1"></circle>
              <path d="m7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
          {% when 'tag' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
              <line x1="7" y1="7" x2="7.01" y2="7"></line>
            </svg>
          {% when 'percent' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="19" y1="5" x2="5" y2="19"></line>
              <circle cx="6.5" cy="6.5" r="2.5"></circle>
              <circle cx="17.5" cy="17.5" r="2.5"></circle>
            </svg>
          {% when 'dollar' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
          {% when 'gift' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20,12 20,22 4,22 4,12"></polyline>
              <rect x="2" y="7" width="20" height="5"></rect>
              <line x1="12" y1="22" x2="12" y2="7"></line>
              <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path>
              <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
            </svg>
          {% when 'sale' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2"></rect>
              <path d="M9 9h6v6H9z"></path>
              <path d="M9 1v6M15 1v6M9 17v6M15 17v6M1 9h6M1 15h6M17 9h6M17 15h6"></path>
            </svg>
          {% when 'discount' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
              <line x1="8" y1="21" x2="16" y2="21"></line>
              <line x1="12" y1="17" x2="12" y2="21"></line>
            </svg>
          {% when 'special' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          {% when 'cart' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="8" cy="21" r="1"></circle>
              <circle cx="19" cy="21" r="1"></circle>
              <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path>
            </svg>
          {% when 'price_down' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6,9 12,15 18,9"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
          {% when 'flash' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="13,2 3,14 12,14 11,22 21,10 12,10 13,2"></polygon>
            </svg>
          {% when 'shield' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
          {% when 'star' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon>
            </svg>
          {% when 'eye' %}
            <svg width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
        {% endcase %}
      </span>
    {% endif %}
    <span class="map-guard-text">{{ display_message }}</span>
  </div>

  <style>
    .map-guard-message {
      background-color: {{ block.settings.background_color | default: '#f8f9fa' }};
      border: 1px solid {{ block.settings.border_color | default: '#dee2e6' }};
      border-radius: {{ block.settings.border_radius | default: 6 }}px;
      padding: {{ block.settings.padding | default: 12 }}px;
      margin: {{ block.settings.margin | default: 10 }}px 0;
      font-size: {{ block.settings.font_size | default: 14 }}px;
      color: {{ block.settings.text_color | default: '#495057' }};
      text-align: {{ block.settings.text_align | default: 'left' }};
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .map-guard-icon {
      display: flex;
      align-items: center;
      flex-shrink: 0;
      color: {{ block.settings.icon_color | default: '#495057' }};
    }
    
    .map-guard-text {
      font-weight: {{ block.settings.font_weight | default: 'normal' }};
      flex: 1;
    }
    
    {% if block.settings.custom_css != blank %}
      {{ block.settings.custom_css }}
    {% endif %}
  </style>
{% endif %}

{% schema %}
{
  "name": "MAP Guard Message",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Message Settings"
    },
    {
      "type": "text",
      "id": "default_message",
      "label": "Default Message",
      "default": "Configure your MAP message here",
      "info": "This message will be used if no custom message is set for the variant"
    },
    {
      "type": "select",
      "id": "icon_type",
      "label": "Icon",
      "options": [
        { "value": "none", "label": "No Icon" },
        { "value": "info", "label": "Information" },
        { "value": "warning", "label": "Warning" },
        { "value": "lock", "label": "Lock" },
        { "value": "tag", "label": "Price Tag" },
        { "value": "percent", "label": "Percent (Discount)" },
        { "value": "dollar", "label": "Dollar Sign" },
        { "value": "gift", "label": "Gift/Offer" },
        { "value": "sale", "label": "Sale Badge" },
        { "value": "discount", "label": "Discount Coupon" },
        { "value": "special", "label": "Special Offer" },
        { "value": "cart", "label": "Shopping Cart" },
        { "value": "price_down", "label": "Price Down" },
        { "value": "flash", "label": "Flash Sale" },
        { "value": "shield", "label": "Shield/Protection" },
        { "value": "star", "label": "Star/Premium" },
        { "value": "eye", "label": "Eye/View" }
      ],
      "default": "none"
    },
    {
      "type": "color",
      "id": "icon_color",
      "label": "Icon Color",
      "default": "#495057"
    },
    {
      "type": "range",
      "id": "icon_size",
      "label": "Icon Size",
      "min": 12,
      "max": 32,
      "step": 2,
      "unit": "px",
      "default": 16
    },
    {
      "type": "header",
      "content": "Styling"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#f8f9fa"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border Color",
      "default": "#dee2e6"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#495057"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border Radius",
      "min": 0,
      "max": 20,
      "step": 1,
      "unit": "px",
      "default": 6
    },
    {
      "type": "range",
      "id": "padding",
      "label": "Padding",
      "min": 0,
      "max": 30,
      "step": 2,
      "unit": "px",
      "default": 12
    },
    {
      "type": "range",
      "id": "margin",
      "label": "Margin",
      "min": 0,
      "max": 50,
      "step": 2,
      "unit": "px",
      "default": 10
    },
    {
      "type": "range",
      "id": "font_size",
      "label": "Font Size",
      "min": 10,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 14
    },
    {
      "type": "select",
      "id": "font_weight",
      "label": "Font Weight",
      "options": [
        { "value": "normal", "label": "Normal" },
        { "value": "bold", "label": "Bold" },
        { "value": "600", "label": "Semi Bold" },
        { "value": "300", "label": "Light" }
      ],
      "default": "normal"
    },
    {
      "type": "select",
      "id": "text_align",
      "label": "Text Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    },
    {
      "type": "header",
      "content": "Advanced"
    },
    {
      "type": "textarea",
      "id": "custom_css",
      "label": "Custom CSS",
      "info": "Add custom CSS to further customize the appearance"
    }
  ]
}
{% endschema %}
